<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>本地密码管理器（静态页面）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 轻微美化 */
    html,body,#app{height:100%}
    .blur-bg{backdrop-filter: blur(6px);}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="app" class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6">
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-semibold">本地密码管理器</h1>
        <div class="flex gap-2 items-center">
          <button id="lockBtn" class="px-3 py-1 rounded-md border">锁定</button>
          <button id="exportBtn" class="px-3 py-1 rounded-md bg-sky-600 text-white">导出</button>
        </div>
      </header>

      <!-- Unlock / Master password -->
      <div id="unlockArea" class="mb-4">
        <label class="block text-sm mb-2">主密码（用于加密本地数据）</label>
        <div class="flex gap-2">
          <input id="masterInput" type="password" class="flex-1 px-3 py-2 rounded-md border" placeholder="输入主密码以解锁 / 设置" />
          <button id="unlockBtn" class="px-4 py-2 rounded-md bg-emerald-600 text-white">解锁</button>
          <button id="setBtn" class="px-4 py-2 rounded-md border">设置/重置</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">提示：主密码不会离开本地（只保存在内存中），请牢记或导出备份。</p>
      </div>

      <!-- Controls -->
      <div class="flex gap-3 mb-4">
        <input id="search" type="search" placeholder="搜索网站、账号或备注" class="flex-1 px-3 py-2 rounded-md border" />
        <button id="newBtn" class="px-4 py-2 rounded-md bg-indigo-600 text-white">新增条目</button>
        <button id="genBtn" class="px-4 py-2 rounded-md border">生成密码</button>
      </div>

      <!-- List -->
      <div id="list" class="space-y-3 max-h-72 overflow-auto">
        <!-- 动态渲染条目 -->
      </div>

      <!-- Generator / Modal area -->
      <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50">
        <div class="absolute inset-0 bg-black opacity-30"></div>
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-2xl w-full z-10">
          <h3 class="text-lg font-medium mb-3">新增 / 编辑条目</h3>
          <div class="grid grid-cols-1 gap-3">
            <input id="site" placeholder="网站（例：example.com）" class="px-3 py-2 rounded-md border" />
            <input id="username" placeholder="用户名 / 邮箱" class="px-3 py-2 rounded-md border" />
            <div class="flex gap-2">
              <input id="password" placeholder="密码" class="flex-1 px-3 py-2 rounded-md border" />
              <button id="toggleShow" class="px-3 py-2 rounded-md border">显示</button>
              <button id="copyPwd" class="px-3 py-2 rounded-md border">复制</button>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm">强度：</label>
              <div id="strengthBar" class="h-2 flex-1 bg-slate-200 rounded overflow-hidden">
                <div id="strengthFill" class="h-full w-0"></div>
              </div>
              <span id="strengthText" class="text-sm w-20 text-right"></span>
            </div>
            <textarea id="note" rows="3" placeholder="备注（可选）" class="px-3 py-2 rounded-md border"></textarea>
            <div class="flex justify-end gap-2">
              <button id="cancelBtn" class="px-4 py-2 rounded-md border">取消</button>
              <button id="saveBtn" class="px-4 py-2 rounded-md bg-emerald-600 text-white">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Password generator drawer -->
      <div id="genPanel" class="fixed right-6 bottom-6 bg-white rounded-xl shadow-lg p-4 hidden">
        <div class="mb-2 font-medium">密码生成器</div>
        <div class="flex gap-2 mb-2">
          <input id="length" type="number" min="6" max="64" value="16" class="w-20 px-2 py-1 rounded-md border" />
          <label><input id="optLower" type="checkbox" checked /> 小写</label>
          <label><input id="optUpper" type="checkbox" checked /> 大写</label>
          <label><input id="optNumber" type="checkbox" checked /> 数字</label>
          <label><input id="optSymbol" type="checkbox" checked /> 符号</label>
        </div>
        <div class="flex gap-2">
          <input id="generated" class="flex-1 px-3 py-1 rounded-md border" readonly />
          <button id="genNow" class="px-3 py-1 rounded-md border">生成</button>
          <button id="useGen" class="px-3 py-1 rounded-md bg-indigo-600 text-white">使用</button>
        </div>
      </div>

      <footer class="mt-4 text-xs text-slate-500">注意：此页面为纯客户端工具，数据只保存在本地浏览器。不要在不受信任的环境下输入敏感信息。</footer>
    </div>
  </div>

<script>
// ---------- 简单本地加密（Web Crypto）和条目管理 ----------
let db = { entries: [] };
let masterKey = null; // CryptoKey
let unlocked = false;
let editingId = null;

const enc = new TextEncoder();
const dec = new TextDecoder();

async function deriveKey(password, salt) {
  const pwKey = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2', salt: salt, iterations: 250000, hash: 'SHA-256'}, pwKey,
    {name:'AES-GCM', length: 256}, false, ['encrypt','decrypt']);
}

async function encryptData(key, obj) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const plaintext = enc.encode(JSON.stringify(obj));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, plaintext);
  return {iv: arrayBufferToBase64(iv), ct: arrayBufferToBase64(ct)};
}

async function decryptData(key, payload) {
  const iv = base64ToArrayBuffer(payload.iv);
  const ct = base64ToArrayBuffer(payload.ct);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  return JSON.parse(dec.decode(pt));
}

function arrayBufferToBase64(buf){
  return btoa(String.fromCharCode(...new Uint8Array(buf)));
}
function base64ToArrayBuffer(b64){
  const bin = atob(b64);
  const arr = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
  return arr.buffer;
}

function saveToLocalStorage(raw) {
  localStorage.setItem('pwdmgr_v1', JSON.stringify(raw));
}
function loadFromLocalStorage(){
  const s = localStorage.getItem('pwdmgr_v1');
  return s ? JSON.parse(s) : null;
}

// UI helpers
function showToast(msg){ alert(msg); }

// Render list
function renderList(filter=''){
  const list = document.getElementById('list');
  list.innerHTML = '';
  const items = db.entries.filter(e=> (e.site+e.username+ (e.note||'')).toLowerCase().includes(filter.toLowerCase()));
  if(items.length===0){ list.innerHTML = '<div class="p-4 text-center text-slate-500">无条目</div>'; return; }
  for(const it of items){
    const div = document.createElement('div');
    div.className = 'p-3 border rounded-lg flex items-center justify-between';
    div.innerHTML = `
      <div>
        <div class="font-medium">${escapeHtml(it.site)} <span class="text-sm text-slate-500">${escapeHtml(it.username)}</span></div>
        <div class="text-sm text-slate-500 truncate max-w-xl">${escapeHtml(it.note||'')}</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="px-3 py-1 rounded-md border" data-id="${it.id}" data-action="view">查看</button>
        <button class="px-3 py-1 rounded-md border" data-id="${it.id}" data-action="edit">编辑</button>
        <button class="px-3 py-1 rounded-md border" data-id="${it.id}" data-action="del">删除</button>
      </div>`;
    list.appendChild(div);
  }
}

function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// Buttons
document.getElementById('newBtn').addEventListener('click', ()=>openModal());
document.getElementById('cancelBtn').addEventListener('click', closeModal);
document.getElementById('genBtn').addEventListener('click', toggleGen);
document.getElementById('genNow').addEventListener('click', ()=>{ document.getElementById('generated').value = generatePassword(); });
document.getElementById('useGen').addEventListener('click', ()=>{ document.getElementById('password').value = document.getElementById('generated').value; updateStrength(); closeGen(); });
document.getElementById('saveBtn').addEventListener('click', saveEntry);
document.getElementById('unlockBtn').addEventListener('click', unlockWithMaster);
document.getElementById('setBtn').addEventListener('click', setMasterAndEncrypt);
document.getElementById('search').addEventListener('input', (e)=>renderList(e.target.value));
document.getElementById('exportBtn').addEventListener('click', exportBackup);
document.getElementById('lockBtn').addEventListener('click', lockAll);

document.getElementById('list').addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id;
  const action = btn.dataset.action;
  if(action==='view') viewEntry(id);
  if(action==='edit') editEntry(id);
  if(action==='del') deleteEntry(id);
});

document.getElementById('password').addEventListener('input', updateStrength);
document.getElementById('toggleShow').addEventListener('click', ()=>{
  const p = document.getElementById('password'); p.type = p.type==='password' ? 'text' : 'password';
});
document.getElementById('copyPwd').addEventListener('click', ()=>{
  navigator.clipboard.writeText(document.getElementById('password').value).then(()=>showToast('已复制到剪贴板'));
});

// Modal open/close
function openModal(entry){
  document.getElementById('modal').classList.remove('hidden');
  if(entry){
    editingId = entry.id;
    document.getElementById('site').value = entry.site;
    document.getElementById('username').value = entry.username;
    document.getElementById('password').value = entry.password;
    document.getElementById('note').value = entry.note||'';
    updateStrength();
  } else {
    editingId = null;
    document.getElementById('site').value='';document.getElementById('username').value='';document.getElementById('password').value='';document.getElementById('note').value='';
    updateStrength();
  }
}
function closeModal(){ document.getElementById('modal').classList.add('hidden'); }
function toggleGen(){ const p=document.getElementById('genPanel'); p.classList.toggle('hidden'); }
function closeGen(){ document.getElementById('genPanel').classList.add('hidden'); }

// CRUD
function saveEntry(){
  if(!unlocked){ showToast('请先解锁'); return; }
  const site = document.getElementById('site').value.trim();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const note = document.getElementById('note').value.trim();
  if(!site){ showToast('请填写网站字段'); return; }
  if(editingId){
    const idx = db.entries.findIndex(e=>e.id===editingId);
    if(idx>=0){ db.entries[idx] = {...db.entries[idx], site, username, password, note, updated: Date.now()}; }
  } else {
    db.entries.push({id: crypto.randomUUID(), site, username, password, note, created: Date.now()});
  }
  persist(); closeModal(); renderList(document.getElementById('search').value);
}
function viewEntry(id){
  const e = db.entries.find(x=>x.id===id); if(!e) return;
  openModal(e);
}
function editEntry(id){ viewEntry(id); }
function deleteEntry(id){ if(!confirm('确定删除该条目？')) return; db.entries = db.entries.filter(e=>e.id!==id); persist(); renderList(); }

// Persistence: encrypt db and save
async function persist(){
  if(!masterKey) return;
  const salt = localStorage.getItem('pwdmgr_salt') ? base64ToArrayBuffer(localStorage.getItem('pwdmgr_salt')) : crypto.getRandomValues(new Uint8Array(16)).buffer;
  // encrypt db
  const payload = await encryptData(masterKey, db);
  saveToLocalStorage({payload, salt: arrayBufferToBase64(salt)});
}

async function unlockWithMaster(){
  const pwd = document.getElementById('masterInput').value;
  if(!pwd){ showToast('请输入主密码'); return; }
  const raw = loadFromLocalStorage();
  if(!raw){ showToast('未找到已保存数据，已创建新数据库（将使用此主密码加密）');
    const salt = crypto.getRandomValues(new Uint8Array(16));
    masterKey = await deriveKey(pwd, salt);
    localStorage.setItem('pwdmgr_salt', arrayBufferToBase64(salt));
    db = {entries:[]}; unlocked=true; renderList(); return;
  }
  const salt = base64ToArrayBuffer(raw.salt);
  try{
    const key = await deriveKey(pwd, salt);
    const decDb = await decryptData(key, raw.payload);
    masterKey = key; db = decDb; unlocked=true; renderList(); showToast('解锁成功');
  }catch(e){ console.error(e); showToast('解锁失败：主密码错误或数据损坏'); }
}

async function setMasterAndEncrypt(){
  const pwd = document.getElementById('masterInput').value;
  if(!pwd){ showToast('请输入要设置的主密码'); return; }
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const key = await deriveKey(pwd, salt);
  masterKey = key; unlocked = true;
  localStorage.setItem('pwdmgr_salt', arrayBufferToBase64(salt));
  await persist(); showToast('主密码已设置并加密当前数据');
}

function lockAll(){ masterKey=null; unlocked=false; db={entries:[]}; renderList(); showToast('已锁定（本地内存已清除，仍可使用主密码解锁）'); }

// On load: try to show placeholder
(function init(){
  const raw = loadFromLocalStorage();
  if(!raw) { renderList(); return; }
  // show counts but data locked
  renderList();
})();

// Export backup
function exportBackup(){
  const raw = loadFromLocalStorage();
  if(!raw){ showToast('无导出数据'); return; }
  const blob = new Blob([JSON.stringify(raw, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='pwdmgr-backup.json'; a.click(); URL.revokeObjectURL(url);
}

// Password generator & strength
function generatePassword(){
  const len = parseInt(document.getElementById('length').value||16,10);
  const lower = document.getElementById('optLower').checked;
  const upper = document.getElementById('optUpper').checked;
  const num = document.getElementById('optNumber').checked;
  const sym = document.getElementById('optSymbol').checked;
  let pool = '';
  if(lower) pool += 'abcdefghijklmnopqrstuvwxyz';
  if(upper) pool += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  if(num) pool += '0123456789';
  if(sym) pool += '!@#$%^&*()-_=+[]{};:,.<>?/`~';
  if(!pool) return '';
  let out='';
  const rand = new Uint32Array(len);
  crypto.getRandomValues(rand);
  for(let i=0;i<len;i++) out += pool[rand[i] % pool.length];
  return out;
}

function updateStrength(){
  const p = document.getElementById('password').value||'';
  const score = calcStrength(p);
  const fill = document.getElementById('strengthFill');
  const txt = document.getElementById('strengthText');
  const w = Math.min(100, score*20);
  fill.style.width = w + '%';
  fill.style.background = score >=4 ? 'linear-gradient(90deg,#16a34a,#059669)' : score>=2 ? 'linear-gradient(90deg,#f59e0b,#f97316)' : 'linear-gradient(90deg,#ef4444,#dc2626)';
  txt.textContent = ['极弱','弱','中等','强','非常强'][Math.max(0,Math.min(4,score))] || '';
}

function calcStrength(p){
  let score=0;
  if(p.length>=8) score++;
  if(p.length>=12) score++;
  if(/[a-z]/.test(p) && /[A-Z]/.test(p)) score++;
  if(/[0-9]/.test(p) && /[^A-Za-z0-9]/.test(p)) score++;
  return score;
}

// util: read file import (not UI exposed yet)

</script>
</body>
</html>
